FROM golang:1.24-alpine

# CGO + sqlite ржПрж░ ржЬржирзНржп ржкрзНржпрж╛ржХрзЗржЬ
RUN apk add --no-cache gcc g++ musl-dev sqlite-dev

WORKDIR /app

# ржЖржЧрзЗ рж╢рзБржзрзБ go.mod ржХржкрж┐ ржХрж░рзЗ dependency cache ржирзЗржм
COPY go.mod ./
RUN go mod download

# ржПржЦржи ржмрж╛ржХрж┐ ржХрзЛржб ржХржкрж┐
COPY . .

# ржПржЦрж╛ржирзЗ go.sum/ржбрж┐ржкрзЗржирзНржбрзЗржирзНрж╕рж┐ рж╕ржм ржарж┐ржХ ржХрж░рзЗ ржирзЗржмрзЗ
RUN go mod tidy

# ЁЯСЙ CGO_ENABLED=1 рж░рзЗржЦрзЗ binary build
RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o urlshortner

# runtime ENV
ENV DB_PATH=/data/go.db \
    REDIS_HOST=redis \
    REDIS_PORT=6379

VOLUME ["/data"]
EXPOSE 8000

CMD ["./urlshortner"]
